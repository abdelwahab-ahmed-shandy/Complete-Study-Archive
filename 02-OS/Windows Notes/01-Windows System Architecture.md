## 🧠 أولاً: **المستويان الأساسيان في Windows**

#### 🔸 1. **Kernel Mode (وضع النواة - مستوى النظام)**

- يمتلك أعلى صلاحيات في النظام.

- إذا تم استغلال ثغرة هنا، يمكن للمهاجم السيطرة الكاملة على الجهاز (Privilege Escalation).

- يشمل المكونات التي تتعامل مباشرة مع العتاد والهاردوير.

#### 🔸 2. **User Mode (وضع المستخدم - مستوى التطبيقات)**

- أقل صلاحيات – يُمنع من الوصول المباشر إلى العتاد.

- البرامج العادية تعمل هنا مثل المتصفحات، برامج التحرير، إلخ.

- يحمي النظام نفسه من أخطاء أو هجمات التطبيقات.
---
## 🧩 ثانيًا: **المكونات الرئيسية داخل Kernel Mode**

#### 1. **Executive (المسؤول التنفيذي)**

- يوفّر الوظائف الأساسية للنظام مثل:
    
    - إدارة العمليات (Process Management)
    
    - إدارة الذاكرة (Memory Manager)
    
    - إدارة الأمان (Security Reference Monitor)

#### 📦 بعض الوحدات داخله:
|الوحدة|الوظيفة|
|---|---|
|**Object Manager**|إدارة كل الموارد ككائنات (Processes, Files, Threads)|
|**Memory Manager**|تخصيص وتحكم في استخدام الذاكرة|
|**Process Manager**|تشغيل وتوقف العمليات والتحكم في أولوياتها|
|**I/O Manager**|إدارة كل عمليات القراءة والكتابة من وإلى الأجهزة|
|**Security Reference Monitor (SRM)**|التحقق من صلاحيات الوصول – مهم في الـ Forensics|
|**Configuration Manager**|إدارة الريجستري (Registry)|
#### 2. **HAL (Hardware Abstraction Layer)**

- طبقة وسيطة بين Windows والأجهزة الفعلية.

- تسمح للنظام بالعمل على أنواع مختلفة من العتاد بنفس الأسلوب.

- لا تُرى كثيرًا، لكنّ فهمها مهم في تحليلات الـ **Rootkits** المتقدمة.

#### 3. **Device Drivers (تعريفات الأجهزة)**

- برامج صغيرة تُحمّل في Kernel Mode للتحكم في الأجهزة (مثل الماوس، الكيبورد، كرت الشبكة).

- قد تكون **هدفًا للهجمات**: تثبيت Drivers ضارة، أو استغلال ضعف في تعريف معين.

- يمكنك فحصها بالأداة: `sigverif.exe` أو من `Device Manager`.
---
## 💡 ثالثًا: **المكونات داخل User Mode**

#### 1. **Environment Subsystems**

> نوافذ البرمجيات التي تسمح بتشغيل تطبيقات من بيئات مختلفة.

|النوع|الوظيفة|
|---|---|
|**Windows Subsystem**|لتشغيل تطبيقات Windows التقليدية|
|**POSIX Subsystem (قديم)**|لتشغيل برامج UNIX|
|**WOW64**|يسمح بتشغيل تطبيقات 32-bit على نظام 64-bit|

#### 2. **User Applications**

- كل البرامج التي تقوم بتشغيلها.

- عند تشغيلها، يُنشأ لها **Process** يتكون من:
    - **Thread(s)** – الخيط الذي ينفذ التعليمات.
    
    - **Handles** – مؤشرات للملفات، الشبكات، إلخ.
    
    - **Access Token** – يحدد صلاحيات المستخدم.
---
##  🧪 رابعًا: **تفصيل دورة حياة العملية في Windows (Process Lifecycle)**

- **المستخدم يشغّل برنامجًا** → تنشأ عملية `Process`

- يحصل على **Access Token** بناءً على صلاحيات المستخدم

- تُحمّل مكتبات النظام مثل `ntdll.dll`, `kernel32.dll`

- تُنشئ الخيوط Threads ويبدأ التنفيذ

- يمكن للتطبيق فتح ملفات، إرسال بيانات، استهلاك RAM
---
## 🔐 خامسًا: **آليات الأمان في الهيكلية**
|الآلية|الدور الأمني|
|---|---|
|**Access Tokens**|تمنع التطبيقات من استخدام صلاحيات أكثر من اللازم|
|**UAC (User Account Control)**|يمنع التطبيقات من التعديل دون إذن|
|**Data Execution Prevention (DEP)**|يمنع تنفيذ الكود في مناطق غير مخصصة|
|**ASLR (Address Space Layout Randomization)**|يصعب تخمين عناوين الذاكرة|
|**Code Signing**|لا يُسمح بتشغيل التعريفات غير الموقعة في الوضع الآمن|

---
## 🛠️ سادسًا: أدوات لفحص هذه الهيكلية
|الأداة|الوظيفة|
|---|---|
|**Process Hacker / Process Explorer**|تحليل العمليات، الـ DLLs، الاتصالات|
|**WinObj**|استعراض كائنات النظام (من Object Manager)|
|**Autoruns**|فحص البرامج التي تعمل عند الإقلاع|
|**ProcMon**|تسجيل كل أحداث النظام: ملفات، Registry، عمليات|
|**WinDbg**|فحص النظام والذاكرة (للتحقيق المتقدم)|

---
## 🧪 مثال تطبيقي (Forensics / Malware Analysis):

**سيناريو**: يوجد ملف مشبوه يعمل في الخلفية، وأنت تريد تحليله:

1. افتح **Process Explorer**
    
2. ابحث عن العملية – افحص:
    
    - المسار الكامل للملف
    
    - هل هو موقّع؟
    
    - ما الـ DLLs التي يحمّلها؟
    
    - هل يتصل بالإنترنت؟
    
3. افتح **ProcMon** وشغّل الفلتر على الـ PID الخاص به
    
4. راقب ما الملفات التي يعدّلها، وما الـ Registry Keys التي يتعامل معها
    
5. يمكن تحليل ملف الـ EXE لاحقًا بأداة مثل PEStudio أو CFF Explorer















